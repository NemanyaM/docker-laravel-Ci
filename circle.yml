machine:
  php:
    version: 7.0.21
  environment:
    APP_ENV: testing
    APP_KEY: APP_KEY=base64:5HXwTe1+iVZUTCo5L/8Vovh0olipl+5P3+6P1sWjomo=


general:
  artifacts:
    - "reports"

dependencies:
  pre:
    - sed -i 's/^;//' ~/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini # enables xdebug needed for code coverage
  override:
    # Checks all php files within /app for syntax errors
    - tests/commands/phplint.sh
    - composer install --prefer-dist --no-interaction
    # Run the CS fixer and error if it finds files to update
    - tests/commands/php-cs-fixer-check.sh
  cache_directories:
    - "~/.composer/cache"
    - "reports/phplint/.cache"
    - "vendor"

test:
  override:
   - vendor/bin/phpunit -d memory_limit=1024M --coverage-clover build/logs/clover.xml

    steps:
         - checkout
         - restore_cache:
             keys:
               - gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
         - save_cache:
             key: gem-cache-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
             paths:
               - vendor/bundle